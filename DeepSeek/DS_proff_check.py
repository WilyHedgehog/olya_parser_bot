# Please install OpenAI SDK first: `pip3 install openai`
import os
from openai import OpenAI
from config.config import load_config
import asyncio
from logging import getLogger
logger = getLogger(__name__)
config = load_config()
api = config.deepseek.api_key
semaphore = asyncio.Semaphore(1)

client = OpenAI(api_key=api, base_url="https://api.deepseek.com")

system = """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤—ã–¥–∞–≤–∞—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã: –ø—Ä–æ—Ñ–µ—Å—Å–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏ –≤–∞–∫–∞–Ω—Å–∏—è.

–ü—Ä–∞–≤–∏–ª–∞:

1. –ù–∞ –≤—Ö–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–≤–∞ —Ç–µ–∫—Å—Ç–∞:
   - –°–æ–æ–±—â–µ–Ω–∏–µ (–∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–∫–∞–Ω—Å–∏–µ–π, —Ä–µ–∫–ª–∞–º–æ–π, —Ä–µ–∑—é–º–µ, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏–ª–∏ –¥—Ä—É–≥–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π)
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫", "–î–∏–∑–∞–π–Ω–µ—Ä UI/UX")

2. –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—à—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ **–≤–∞–∫–∞–Ω—Å–∏–µ–π**.  
   - –í–∞–∫–∞–Ω—Å–∏—è ‚Äî —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –≥–¥–µ **—Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –∏—â–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è**.  
   - –ò–≥–Ω–æ—Ä–∏—Ä—É–π: —Ä–µ–∫–ª–∞–º—É —É—Å–ª—É–≥, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤, —Ä–µ–∑—é–º–µ, –ø–æ—Å—Ç—ã —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä—ã –∏ —Ç.–ø.  
   - –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∫–∞–Ω—Å–∏–µ–π, –æ—Ç–≤–µ—Ç ‚Äî **0** –∏ –¥–∞–ª—å–Ω–µ–π—à–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

3. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∫–∞–Ω—Å–∏–µ–π, –ø—Ä–æ–≤–µ—Ä—è–µ—à—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏.  
   - –ï—Å–ª–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ (–æ–ø—ã—Ç, –Ω–∞–≤—ã–∫–∏, –¥–æ–ª–∂–Ω–æ—Å—Ç—å), –≤–æ–∑–≤—Ä–∞—â–∞–π **1**.  
   - –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–π **0**.

4. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: **—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞: 0 –∏–ª–∏ 1**, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.

–ü—Ä–∏–º–µ—Ä—ã:

–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: "Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫"  
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ö–æ–º–ø–∞–Ω–∏—è –∏—â–µ—Ç Python-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è Django-–ø—Ä–æ–µ–∫—Ç–∞"  
–û—Ç–≤–µ—Ç: `1`

–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: "Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫"  
–°–æ–æ–±—â–µ–Ω–∏–µ: "–§—Ä–∏–ª–∞–Ω—Å–µ—Ä –∏—â–µ—Ç –∑–∞–∫–∞–∑—ã –ø–æ Photoshop –∏ –¥–∏–∑–∞–π–Ω—É"  
–û—Ç–≤–µ—Ç: `0`

–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: "–î–∏–∑–∞–π–Ω–µ—Ä UI/UX"  
–°–æ–æ–±—â–µ–Ω–∏–µ: "–ü—Ä–æ–¥–∞—é –∫—É—Ä—Å –ø–æ Figma"  
–û—Ç–≤–µ—Ç: `0`
"""

async def ai_proff_check(text: str, proff: str) -> str:
    async with semaphore: 
        try:
            async def run_sync():
                response = client.chat.completions.create(
                    model="deepseek-chat",
                    messages=[
                        {"role": "system", "content": system},
                        {"role": "user", "content": f"–°–æ–æ–±—â–µ–Ω–∏–µ: {text}\n–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {proff}"},
                    ],
                    stream=False
                )
                return response.choices[0].message.content

            # üïì –æ–≥—Ä–∞–Ω–∏—á–∏–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –∑–∞–≤–∏—Å –Ω–∞–≤—Å–µ–≥–¥–∞
            result = await asyncio.wait_for(asyncio.to_thread(run_sync), timeout=30)

            logger.info(f"‚úÖ AI –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ '{proff}' –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {result}")
            return result

        except asyncio.TimeoutError:
            logger.error(f"‚è± –¢–∞–π–º-–∞—É—Ç –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ '{proff}'")
            return "0"

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ DeepSeek API: {e}")
            return "0"